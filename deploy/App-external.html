<!DOCTYPE html>
<html>
<head>
    <title>investmentcategory</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("CustomApp",{extend:"Rally.app.TimeboxScopedApp",scopeType:"release",stateful:!0,getSettingsFields:function(){return[{name:"onlyshowaccepted",xtype:"rallycheckboxfield",fieldLabel:"",boxLabel:"Only show accepted work items."}]},config:{defaultSettings:{onlyshowaccepted:!0}},noFeatureId:3,noInvestmentCategory:"Unplanned Stories",noInvestmentColor:"#666",cvFeatureId:1,cvInvestmentCategory:"CV Defects",cvInvestmentColor:"#FF8200",defectFeatureId:2,defectInvestmentCategory:"non-CV Defects",defectInvestmentColor:"#F6A900",colors:["#B81B10","#FAD200","#F66349","#FFDD82"],chartColors:[],features:[],workItems:[],totalPoint:0,filterContainer:null,noDataLabel:null,fromDateField:null,toDateField:null,appliedFromDate:null,appliedToDate:null,firstlaunch:!1,app:null,launch:function(){app=this,filterContainer=app.down("container"),app.firstLaunch=!0,app.callParent(arguments)},onScopeChange:function(scope){app.callParent(arguments),app.initializeFilters()},getState:function(){return app.fromDateField&&app.toDateField?{fromDate:app.fromDateField.value,toDate:app.toDateField.value}:{fromDate:null,toDate:null}},applyState:function(state){this.appliedFromDate=state.fromDate,this.appliedToDate=state.toDate},initializeFilters:function(){if(app.hideHeader(!1),filterContainer){var orLabelId="orLabel",fromDateFieldId="fromDateFilter",toDateFieldId="toDateFilter",beginButtonId="beginButton",beginButton=filterContainer.down("#"+beginButtonId);beginButton||(filterContainer.add({xtype:"label",html:"--or--",anchor:"100%",itemId:orLabelId}),app.fromDateField=filterContainer.add({xtype:"datefield",anchor:"100%",fieldLabel:"From",itemId:fromDateFieldId,name:"from_date",value:this.appliedFromDate?new Date(this.appliedFromDate):null}),app.toDateField=filterContainer.add({xtype:"datefield",anchor:"100%",fieldLabel:"To",itemId:toDateFieldId,name:"to_date",value:this.appliedToDate?new Date(this.appliedToDate):null}),filterContainer.add({xtype:"rallybutton",itemId:beginButtonId,text:"Apply Release or Date Range",handler:function(){app.saveState(),app.start(app.fromDateField,app.toDateField)},style:{"background-color":app.colors[0],"border-color":app.colors[0]}}),app.firstLaunch&&(app.fromDateField.value||app.toDateField.value||app.getContext().getTimeboxScope().getRecord())&&(app.firstLaunch=!1,app.start(app.fromDateField,app.toDateField)))}else app.start(null,null)},hideHeader:function(hiddenValue){filterContainer&&filterContainer.setVisible(!hiddenValue)},start:function(fromDateField,toDateField){app.down("rallychart")&&app.down("rallychart").destroy(),app.noDataLabel&&app.noDataLabel.destroy(),app._myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Loading..."}),app._myMask.show();var dataScope=app.getContext().getDataContext(),scope=app.getContext().getTimeboxScope().getRecord(),store=Ext.create("Rally.data.wsapi.artifact.Store",{models:["UserStory","Defect"],fetch:["ObjectID","PlanEstimate","Feature","Tags"],context:dataScope,limit:1/0},app),fromDate=fromDateField?fromDateField.value:null,toDate=toDateField?toDateField.value:null;if(fromDate||toDate||!scope){if(fromDate){var fromDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"InProgressDate",operator:">=",value:fromDateField.value});store.addFilter(fromDateFilter,!1)}if(toDate){var toDateFilter=Ext.create("Rally.data.wsapi.Filter",{property:"AcceptedDate",operator:"<=",value:toDateField.value});store.addFilter(toDateFilter,!1)}}else{var releaseFilter=Ext.create("Rally.data.wsapi.Filter",{property:"Release.Name",value:scope.data.Name});store.addFilter(releaseFilter,!1)}var onlyShowAccepted=app.getSetting("onlyshowaccepted");if(onlyShowAccepted){var acceptedFilter=Ext.create("Rally.data.wsapi.Filter",{property:"ScheduleState",operator:">=",value:"Accepted"});store.addFilter(acceptedFilter,!1)}app.features={},app.chartColors=[],app.features[app.cvFeatureId]={},app.features[app.cvFeatureId].estimate=0,app.features[app.cvFeatureId].investmentCategory=app.cvInvestmentCategory,app.chartColors.push(app.cvInvestmentColor),app.features[app.defectFeatureId]={},app.features[app.defectFeatureId].estimate=0,app.features[app.defectFeatureId].investmentCategory=app.defectInvestmentCategory,app.chartColors.push(app.defectInvestmentColor),app.features[app.noFeatureId]={},app.features[app.noFeatureId].estimate=0,app.features[app.noFeatureId].investmentCategory=app.noInvestmentCategory,app.chartColors.push(app.noInvestmentColor),app.workItems=[],app.totalPoints=0,store.load({scope:app,callback:function(records,operation){operation.wasSuccessful()&&(records.length>0?(_.each(records,function(record){var featureId=app.noFeatureId;record.raw.Tags&&_.find(record.raw.Tags._tagsNameArray,function(tag){return"Customer Voice"==tag.Name})?featureId=app.cvFeatureId:record.raw.Feature?featureId=record.raw.Feature.ObjectID:"defect"==record.get("_type")&&(featureId=app.defectFeatureId),featureId in app.features||(app.features[featureId]={},app.features[featureId].estimate=0,app.features[featureId].investmentCategory=app.noInvestmentCategory),app.features[featureId].estimate+=record.raw.PlanEstimate,app.totalPoints+=record.raw.PlanEstimate},app),app._myMask.msg="Loading Features...",app.loadFeatures(0)):app.showNoDataBox())}})},loadFeatures:function(featureIndex){var keys=Object.keys(app.features);if(featureIndex>=keys.length)app.compileData();else if(keys[featureIndex]==app.noFeatureId||keys[featureIndex]==app.defectFeatureId||keys[featureIndex]==app.cvFeatureId)app.loadFeatures(featureIndex+1);else{app.features[keys[featureIndex]].investmentCategory="Unknown";var dataScope={workspace:app.getContext().getWorkspaceRef(),project:null},store=Ext.create("Rally.data.wsapi.artifact.Store",{models:["PortfolioItem/Feature"],fetch:["ObjectID","InvestmentCategory"],filters:[{property:"ObjectID",value:keys[featureIndex]}],context:dataScope,limit:1/0},app);store.load({scope:app,callback:function(records,operation){operation.wasSuccessful()&&records.length>0&&_.each(records,function(record){var featureId=record.raw.ObjectID;app.features[featureId].investmentCategory=record.raw.InvestmentCategory},app),app.loadFeatures(featureIndex+1)}})}},compileData:function(){app._myMask.msg="Compiling Data...";var investmentSums={};_.each(app.features,function(feature){if(!(feature.investmentCategory in investmentSums)){investmentSums[feature.investmentCategory]=0;var keysLength=Object.keys(investmentSums).length;keysLength>3&&app.chartColors.push(app.colors[(keysLength-4)%app.colors.length])}investmentSums[feature.investmentCategory]+=feature.estimate},app);var series=[];series.push({}),series[0].name="Investment Categories",series[0].colorByPoint=!0,series[0].data=[],_.each(_.keys(investmentSums),function(investmentCategory){series[0].data.push({name:investmentCategory,y:investmentSums[investmentCategory]/app.totalPoints})},app),app.makeChart(series)},makeChart:function(series){var chart=app.add({xtype:"rallychart",chartConfig:{chart:{type:"pie"},title:{text:"Investment Category Spend"},tooltip:{pointFormat:"{series.name}: <b>{point.percentage:.1f}%</b>"},plotOptions:{pie:{allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {point.percentage:.1f} %"}}}},chartData:{series:series}});chart.setChartColors(app.chartColors),app._myMask.hide()},showNoDataBox:function(){app._myMask.hide(),app.noDataLabel=app.add({xtype:"label",text:"No data was found. Check if there are work items assigned for the Release. You may also need to include Child and/or Parent projects in your scope."})}});

            Rally.launchApp('CustomApp', {
                name:"investmentcategory",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
